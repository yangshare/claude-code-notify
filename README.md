# Claude Code Notify (CCN) 产品需求规格说明书

> **版本**: v1.0
> **状态**: 需求确认中
> **核心目标**: 打造 Windows 平台下最优雅、可定制的 Claude Code 任务通知体验。

---

## 1. 产品概述

### 1.3 产品形态 (Product Form Factor)
本产品由以下三个部分组成：
1.  **CLI 核心 (ccn.exe)**：
    -   **无界面、无常驻进程**。它是一个纯粹的命令行工具，被设计为由 Claude Code 的 Hooks 机制按需调用。
    -   极速启动，执行完发送通知逻辑后立即退出，不占用系统资源。
2.  **交互式配置向导 (TUI)**：
    -   通过 `ccn init` 唤起。提供现代化的终端交互界面（类似 npm init），引导用户完成图标、声音和阈值的设置。
3.  **原生通知卡片 (Toast UI)**：
    -   最终呈现给用户的界面。利用 Windows 原生 Notification Center 展示，支持系统级的免打扰、历史记录和交互按钮。

## 2. 集成与使用流程 (Integration Workflow)

为了降低用户的使用门槛，我们设计了“傻瓜式”的集成方案。

### 2.1 自动化集成 (Magic Setup)
用户只需运行一条命令，即可完成所有配置。

```bash
$ ccn setup
```

**该命令执行的幕后逻辑**：
1.  **侦测**: 自动扫描系统路径，定位 Claude Code 的配置文件（通常位于 `~/.claude/config.json` 或 `%APPDATA%\Claude\config.json`）。
2.  **备份**: 在修改前自动创建配置文件备份（例如 `config.json.bak`）。
3.  **注入**: 解析 JSON，在 `hooks` 字段中安全插入 `PostCommand` 和 `CommandError` 钩子。
    -   *注入内容示例*:
        ```json
        {
          "hooks": {
            "PostCommand": "ccn notify --status=success --duration=$DURATION --cmd='$COMMAND'",
            "CommandError": "ccn notify --status=error --duration=$DURATION --cmd='$COMMAND'"
          }
        }
        ```
4.  **验证**: 模拟发送一条测试通知，确保配置生效。

### 2.2 手动集成 (Power User)
对于希望完全掌控配置的高级用户，我们也提供标准文档：
1.  下载 `ccn.exe` 并将其添加到系统 PATH。
2.  打开 Claude Code 配置文件。
3.  手动添加 Hook 触发命令。

---

## 3. 核心功能需求

### 3.1 极致的桌面通知体验 (Desktop Notification Experience)

#### 2.1.1 视觉美化
- **原生样式**：通知必须完全符合 Windows 10/11 的 Fluent Design 设计规范，看起来像系统自带应用一样自然。
- **状态感知图标**：
  - ✅ **成功**：显示绿色对勾或自定义开心图标。
  - ❌ **失败**：显示红色警告或自定义报警图标。
  - ⏳ **等待**：显示黄色沙漏或自定义思考图标。
- **富文本支持**：
  - 标题：显示任务类型（如 "Build Task"）。
  - 内容：支持两行摘要，显示耗时、错误码或关键日志。
  - **进度条 (可选)**：如果 Hook 能提供进度信息，通知卡片底部应显示进度条。

#### 2.1.2 交互能力
- **点击行为**：
  - 点击通知卡片主体：立即激活并置顶 Claude Code 所在的终端窗口。
- **操作按钮 (Action Buttons)**：
  - 通知下方提供快捷按钮，例如：
    - `[查看日志]`：打开日志文件。
    - `[重试]`：(如果可能) 重新执行上一条命令。
    - `[忽略]`：关闭通知。

#### 2.1.3 声音反馈
- **自定义音效**：用户可以为“成功”和“失败”设置不同的系统提示音（System Sounds）或自定义 `.wav` 文件。
- **静音模式**：支持一键静音或根据系统“专注助手”状态自动静音。

### 2.2 智能通知策略 (Smart Notification Policy)

#### 2.2.1 智能阈值 (Smart Threshold)
- **防打扰机制**：默认情况下，执行时间 < **N秒** (默认 10s) 的任务**不发送通知**。
- **强制通知例外**：
  - 即使任务耗时很短，如果状态为 **Error (失败)**，必须发送通知。
  - 用户可配置“白名单命令”，例如 `deploy` 命令无论耗时多久都必须通知。

#### 2.2.2 摘要聚合
- 如果短时间内连续触发多条通知（例如循环测试），应自动聚合为一条：“5个任务已完成 (3成功, 2失败)”，避免刷屏。

### 2.3 配置与个性化 (Configuration)

#### 2.3.1 极简配置
- 提供交互式向导，用户无需手写配置文件即可完成基础设置。

#### 2.3.2 高级自定义
- 允许用户通过配置文件定义“场景化模板”：
  - 场景 A (构建): 使用图标 A，声音 B。
  - 场景 B (测试): 使用图标 C，声音 D。

---

## 3. 非功能需求 (Non-functional Requirements)

- **性能**：通知触发延迟应 < 500ms。
- **兼容性**：优先保障 Windows 10/11 体验，同时兼容 macOS (仅基础通知)。
- **稳定性**：工具自身崩溃不应影响 Claude Code 的正常运行。
